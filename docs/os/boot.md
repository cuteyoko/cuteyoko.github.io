# 操作系统从加电到启动

> 　　"pull oneself up by one's bootstraps"
字面意思是"拽着鞋带把自己拉起来"，这当然是不可能的事情。最早的时候，工程师们用它来比喻，计算机启动是一个很矛盾的过程：必须先运行程序，然后计算机才能启动，但是计算机不启动就无法运行程序！

参考[计算机是如何启动的？](http://www.ruanyifeng.com/blog/2013/02/booting.html)

## 计算机基本组成

一般计算机采用冯诺依曼体系结构：输入系统，输出系统，控制器，运算器，存储器。

其中存储器包括内存和外存，一般前者以高速，断电易失为主要特征， 用以供给CPU数据，后者以相对低速，断电不易失为特征，用以持久化保存。
一般数据会从后者加载到内存中运行。

此处可能会相关的点：
- 存储介质特征及适配场景
- 缓存
- 持久化内存
- 其他体系结构

## 计算机程序运行原理

### CS:IP寄存器

所谓计算机运行程序，本质是CPU将指令加载后进行的运算和控制过程，CPU按照指示从内存的某个位置获得指令，然后按顺序执行。
（简单起见，这里不表述计算机的数据控制和读取流程，直接假设CPU拥有读取内存的能力，详情计算机组成原理）

为了实现上述功能，CPU中存在如下寄存器
- CS: 代码段寄存器
- IP: 指令指针寄存器

其中CS指向要运行的代码段在内存（或者说CPU所认知的地址空间）的起始地址，比如0x000000， 而IP则指向具体执行的指令。

比如当前0x000000地址保存的指令是`mov AX, 0`,而CS:IP刚好组合指向这个位置，那么CPU就会读取这个指令，然后执行。

**执行指令结束时，IP会自动指向下一个命令**

由于当前指令位于0x000000,而指令长度为3(此处可参考RISC/CISC指令集相关知识，考虑CPU如何确定指令长度)，所以CS:IP的实际指向地址就会变为0x000003


### BIOS启动过程

按照当前描述有如下条件：

1. 由于内存空间断电不保存，计算机启动程序（BIOS）不能保存在这里。
2. 计算机程序仅能在内存空间中被执行。
3. 计算机外存数据需要计算机程序运行才能被加载到内存中。

如果不增加其他条件，我们将得出计算机启动程序无法执行的结论。

问题解决方案如下：

初始化的CS:IP地址是确定的（硬件实现），每次上电以后会自动将程序指针指到某个具体位置，然后将一段可以持久化程序的只读内存映射到这个地址从而启动程序，用于系统启动检查，以加载后续工作（比如将操作系统的初始化程序加载到内存中，然后跳转，将CS:IP设置为这个地址）
具体参考[BIOS启动过程](https://chyyuu.gitbooks.io/ucore_os_docs/content/lab1/lab1_3_1_bios_booting.html)。

上述空间中存储的程序即为BIOS。

### 系统加载启动

上文说到BIOS启动后可以将操作系统加载到内存中开始运行。而操作系统存放在硬盘中，BIOS需要按照某种约定去硬盘中将对应文件读取到内存中。简单而言，就是指定磁盘后，BIOS可以自动扫描对应磁盘

这里涉及的知识包括
- 分区（MBR/GPT）
- 引导
- 操作系统初始化过程



