# 程序文件解析

## elf格式

> 在计算机科学中，是一种用于二进制文件、可执行文件、目标代码、共享库和核心转储格式文件。
> 是UNIX系统实验室（USL）作为应用程序二进制接口（Application Binary Interface，ABI）而开发和发布的,
> 也是Linux的主要可执行文件格式。

## 实例解析

例程

```cpp
// file: test.cpp
int foo(int a, int b)
{
    return a + b;
}

```

编译
```
g++ -std=c++11 -c test.cpp
# 生成 test.o
```

通过执行如下命令`xxd test.o`, 查看二进制文件，结果如下

```
0000000: 7f45 4c46 0201 0100 0000 0000 0000 0000  .ELF............
0000010: 0100 3e00 0100 0000 0000 0000 0000 0000  ..>.............
0000020: 0000 0000 0000 0000 2002 0000 0000 0000  ........ .......
0000030: 0000 0000 4000 0000 0000 4000 0b00 0a00  ....@.....@.....
0000040: 5548 89e5 897d fc89 75f8 8b45 f88b 55fc  UH...}..u..E..U.
0000050: 01d0 5dc3 0047 4343 3a20 2847 4e55 2920  ..]..GCC: (GNU) 
0000060: 342e 382e 3520 3230 3135 3036 3233 2028  4.8.5 20150623 (
0000070: 5265 6420 4861 7420 342e 382e 352d 3339  Red Hat 4.8.5-39
0000080: 2900 0000 0000 0000 1400 0000 0000 0000  )...............
0000090: 017a 5200 0178 1001 1b0c 0708 9001 0000  .zR..x..........
00000a0: 1c00 0000 1c00 0000 0000 0000 1400 0000  ................
00000b0: 0041 0e10 8602 430d 064f 0c07 0800 0000  .A....C..O......
00000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000d0: 0000 0000 0000 0000 0100 0000 0400 f1ff  ................
00000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000f0: 0000 0000 0300 0100 0000 0000 0000 0000  ................
0000100: 0000 0000 0000 0000 0000 0000 0300 0200  ................
0000110: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000120: 0000 0000 0300 0300 0000 0000 0000 0000  ................
0000130: 0000 0000 0000 0000 0000 0000 0300 0500  ................
0000140: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000150: 0000 0000 0300 0600 0000 0000 0000 0000  ................
0000160: 0000 0000 0000 0000 0000 0000 0300 0400  ................
0000170: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000180: 0a00 0000 1200 0100 0000 0000 0000 0000  ................
0000190: 1400 0000 0000 0000 0074 6573 742e 6370  .........test.cp
00001a0: 7000 5f5a 3366 6f6f 6969 0000 0000 0000  p._Z3fooii......
00001b0: 2000 0000 0000 0000 0200 0000 0200 0000   ...............
00001c0: 0000 0000 0000 0000 002e 7379 6d74 6162  ..........symtab
00001d0: 002e 7374 7274 6162 002e 7368 7374 7274  ..strtab..shstrt
00001e0: 6162 002e 7465 7874 002e 6461 7461 002e  ab..text..data..
00001f0: 6273 7300 2e63 6f6d 6d65 6e74 002e 6e6f  bss..comment..no
0000200: 7465 2e47 4e55 2d73 7461 636b 002e 7265  te.GNU-stack..re
0000210: 6c61 2e65 685f 6672 616d 6500 0000 0000  la.eh_frame.....
0000220: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000230: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000240: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000250: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000260: 1b00 0000 0100 0000 0600 0000 0000 0000  ................
0000270: 0000 0000 0000 0000 4000 0000 0000 0000  ........@.......
0000280: 1400 0000 0000 0000 0000 0000 0000 0000  ................
0000290: 0100 0000 0000 0000 0000 0000 0000 0000  ................
00002a0: 2100 0000 0100 0000 0300 0000 0000 0000  !...............
00002b0: 0000 0000 0000 0000 5400 0000 0000 0000  ........T.......
00002c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00002d0: 0100 0000 0000 0000 0000 0000 0000 0000  ................
00002e0: 2700 0000 0800 0000 0300 0000 0000 0000  '...............
00002f0: 0000 0000 0000 0000 5400 0000 0000 0000  ........T.......
0000300: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000310: 0100 0000 0000 0000 0000 0000 0000 0000  ................
0000320: 2c00 0000 0100 0000 3000 0000 0000 0000  ,.......0.......
0000330: 0000 0000 0000 0000 5400 0000 0000 0000  ........T.......
0000340: 2e00 0000 0000 0000 0000 0000 0000 0000  ................
0000350: 0100 0000 0000 0000 0100 0000 0000 0000  ................
0000360: 3500 0000 0100 0000 0000 0000 0000 0000  5...............
0000370: 0000 0000 0000 0000 8200 0000 0000 0000  ................
0000380: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000390: 0100 0000 0000 0000 0000 0000 0000 0000  ................
00003a0: 4a00 0000 0100 0000 0200 0000 0000 0000  J...............
00003b0: 0000 0000 0000 0000 8800 0000 0000 0000  ................
00003c0: 3800 0000 0000 0000 0000 0000 0000 0000  8...............
00003d0: 0800 0000 0000 0000 0000 0000 0000 0000  ................
00003e0: 4500 0000 0400 0000 4000 0000 0000 0000  E.......@.......
00003f0: 0000 0000 0000 0000 b001 0000 0000 0000  ................
0000400: 1800 0000 0000 0000 0800 0000 0600 0000  ................
0000410: 0800 0000 0000 0000 1800 0000 0000 0000  ................
0000420: 0100 0000 0200 0000 0000 0000 0000 0000  ................
0000430: 0000 0000 0000 0000 c000 0000 0000 0000  ................
0000440: d800 0000 0000 0000 0900 0000 0800 0000  ................
0000450: 0800 0000 0000 0000 1800 0000 0000 0000  ................
0000460: 0900 0000 0300 0000 0000 0000 0000 0000  ................
0000470: 0000 0000 0000 0000 9801 0000 0000 0000  ................
0000480: 1300 0000 0000 0000 0000 0000 0000 0000  ................
0000490: 0100 0000 0000 0000 0000 0000 0000 0000  ................
00004a0: 1100 0000 0300 0000 0000 0000 0000 0000  ................
00004b0: 0000 0000 0000 0000 c801 0000 0000 0000  ................
00004c0: 5400 0000 0000 0000 0000 0000 0000 0000  T...............
00004d0: 0100 0000 0000 0000 0000 0000 0000 0000  ................
```

对其进行解析，参考如下部分
- [elf格式](https://paper.seebug.org/papers/Archive/refs/elf/Understanding_ELF.pdf)
- [关于elf64](https://tianstcht.github.io/ELF%E6%96%87%E4%BB%B6%E5%9C%A8%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8%E7%9A%84%E9%83%A8%E5%88%86/)
- 查看elfHeader: `readelf -h`


```
readelf -h
=====================
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          544 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           64 (bytes)
  Number of section headers:         11
  Section header string table index: 10
=====================


 【====== ELF HEADER ======】
 
          | x86_64               | 程序入口虚拟地址
【01 00】 【3e00】 【0100  0000】 【0000 0000】 【0000 0000】
| 可重定位文件      | 版本号                     | 程序头表:没有


【0000 0000】 【0000 0000】 【2002】 0000 0000 0000
|节头表：没有                | 节头表

                        | 64位目标文件       | 扩展，暂时不用
0000000: 【7f45 4c46】  【02】 【01】  【01】 【00 0000 0000 0000 0000】
         | magic number       | 小端  | current

         | 可重定位文件   | 当前版本
0000010:【0100】 【3e00】 【0100 0000】 【0000 0000 0000 0000】
                 | 体系结构              | 虚拟地址入口函数
                 
          | 程序头偏移            | 节头偏移
0000020: 【0000 0000 0000 0000】 【2002 0000 0000 0000】

          | flag                 | 程序头大小      | 节头大小        | string table索引
0000030: 【0000 0000】  【4000】 【0000】 【0000】 【4000】 【0b00】 【0a00】
                         | elf header大小 | 程序头元素数量  | 节头元素数量


【 === 查看节 === 】
[root@szvpwebenv00832 test]# readelf -S test.o 
There are 11 section headers, starting at offset 0x220:

Section Headers:
  [Nr] Name              Type             Address           Offset       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000    0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040    0000000000000014  0000000000000000  AX       0     0     1
  [ 2] .data             PROGBITS         0000000000000000  00000054    0000000000000000  0000000000000000  WA       0     0     1
  [ 3] .bss              NOBITS           0000000000000000  00000054    0000000000000000  0000000000000000  WA       0     0     1
  [ 4] .comment          PROGBITS         0000000000000000  00000054    000000000000002e  0000000000000001  MS       0     0     1
  [ 5] .note.GNU-stack   PROGBITS         0000000000000000  00000082    0000000000000000  0000000000000000           0     0     1
  [ 6] .eh_frame         PROGBITS         0000000000000000  00000088    0000000000000038  0000000000000000   A       0     0     8
  [ 7] .rela.eh_frame    RELA             0000000000000000  000001b0    0000000000000018  0000000000000018   I       8     6     8
  [ 8] .symtab           SYMTAB           0000000000000000  000000c0    00000000000000d8  0000000000000018           9     8     8
  [ 9] .strtab           STRTAB           0000000000000000  00000198    0000000000000013  0000000000000000           0     0     1
  [10] .shstrtab         STRTAB           0000000000000000  000001c8    0000000000000054  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  l (large), p (processor specific)

【查看具体节表】

          | .text表 
0000040: 【5548 89e5 897d fc89 75f8 8b45 f88b 55fc  UH...}..u..E..U.
0000050: 01d0 5dc3 】 【0047 4343 3a20 2847 4e55 2920  ..]..GCC: (GNU) 
       data + bss = 0 | -> comment注释节
       
0000060: 342e 382e 3520 3230 3135 3036 3233 2028  4.8.5 20150623 (
0000070: 5265 6420 4861 7420 342e 382e 352d 3339  Red Hat 4.8.5-39
0000080: 2900】 【 0000 0000 0000 1400 0000 】【0000 0000  )...............
                | 对齐                      | | eh_frame
0000090: 017a 5200 0178 1001 1b0c 0708 9001 0000  .zR..x..........
00000a0: 1c00 0000 1c00 0000 0000 0000 1400 0000  ................
00000b0: 0041 0e10 8602 430d 064f 0c07 0800 0000  .A....C..O......
          | symtable
00000c0: 【0000 0000 0000 0000 0000 0000 0000 0000  ................
00000d0: 0000 0000 0000 0000 0100 0000 0400 f1ff  ................

00000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000f0: 0000 0000 0300 0100 0000 0000 0000 0000  ................
0000100: 0000 0000 0000 0000 0000 0000 0300 0200  ................
0000110: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000120: 0000 0000 0300 0300 0000 0000 0000 0000  ................
0000130: 0000 0000 0000 0000 0000 0000 0300 0500  ................
0000140: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000150: 0000 0000 0300 0600 0000 0000 0000 0000  ................
0000160: 0000 0000 0000 0000 0000 0000 0300 0400  ................
0000170: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000180: 0a00 0000 1200 0100 0000 0000 0000 0000  ................
                              | strtab
0000190: 1400 0000 0000 0000 【 0074 6573 742e 6370  .........test.cp
00001a0: 7000 5f5a 3366 6f6f 6969 0000 0000】 0000】  p._Z3fooii......
                                  endof eh_frame  | 
          | .rela.eh_frame 
00001b0: 【2000 0000 0000 0000 0200 0000 0200 0000   ...............
                               | shstrtab
00001c0: 0000 0000 0000 0000】 【002e 7379 6d74 6162  ..........symtab
00001d0: 002e 7374 7274 6162 002e 7368 7374 7274  ..strtab..shstrt
00001e0: 6162 002e 7465 7874 002e 6461 7461 002e  ab..text..data..
00001f0: 6273 7300 2e63 6f6d 6d65 6e74 002e 6e6f  bss..comment..no
0000200: 7465 2e47 4e55 2d73 7461 636b 002e 7265  te.GNU-stack..re
0000210: 6c61 2e65 685f 6672 616d 6500 0000 0000】  la.eh_frame.....
                                                | 


【===== 节头开始 =====】     
0000220: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000230: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000240: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000250: 0000 0000 0000 0000 0000 0000 0000 0000  ................1

0000260: 1b00 0000 0100 0000 0600 0000 0000 0000  ................
0000270: 0000 0000 0000 0000 4000 0000 0000 0000  ........@.......
0000280: 1400 0000 0000 0000 0000 0000 0000 0000  ................
0000290: 0100 0000 0000 0000 0000 0000 0000 0000  ................2

00002a0: 2100 0000 0100 0000 0300 0000 0000 0000  !...............
00002b0: 0000 0000 0000 0000 5400 0000 0000 0000  ........T.......
00002c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00002d0: 0100 0000 0000 0000 0000 0000 0000 0000  ................3

00002e0: 2700 0000 0800 0000 0300 0000 0000 0000  '...............
00002f0: 0000 0000 0000 0000 5400 0000 0000 0000  ........T.......
0000300: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000310: 0100 0000 0000 0000 0000 0000 0000 0000  ................4

0000320: 2c00 0000 0100 0000 3000 0000 0000 0000  ,.......0.......
0000330: 0000 0000 0000 0000 5400 0000 0000 0000  ........T.......
0000340: 2e00 0000 0000 0000 0000 0000 0000 0000  ................
0000350: 0100 0000 0000 0000 0100 0000 0000 0000  ................5

0000360: 3500 0000 0100 0000 0000 0000 0000 0000  5...............
0000370: 0000 0000 0000 0000 8200 0000 0000 0000  ................
0000380: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0000390: 0100 0000 0000 0000 0000 0000 0000 0000  ................6

00003a0: 4a00 0000 0100 0000 0200 0000 0000 0000  J...............
00003b0: 0000 0000 0000 0000 8800 0000 0000 0000  ................
00003c0: 3800 0000 0000 0000 0000 0000 0000 0000  8...............
00003d0: 0800 0000 0000 0000 0000 0000 0000 0000  ................7

00003e0: 4500 0000 0400 0000 4000 0000 0000 0000  E.......@.......
00003f0: 0000 0000 0000 0000 b001 0000 0000 0000  ................
0000400: 1800 0000 0000 0000 0800 0000 0600 0000  ................
0000410: 0800 0000 0000 0000 1800 0000 0000 0000  ................8

0000420: 0100 0000 0200 0000 0000 0000 0000 0000  ................
0000430: 0000 0000 0000 0000 c000 0000 0000 0000  ................
0000440: d800 0000 0000 0000 0900 0000 0800 0000  ................
0000450: 0800 0000 0000 0000 1800 0000 0000 0000  ................9

0000460: 0900 0000 0300 0000 0000 0000 0000 0000  ................
0000470: 0000 0000 0000 0000 9801 0000 0000 0000  ................
0000480: 1300 0000 0000 0000 0000 0000 0000 0000  ................
0000490: 0100 0000 0000 0000 0000 0000 0000 0000  ................0

00004a0: 1100 0000 0300 0000 0000 0000 0000 0000  ................
00004b0: 0000 0000 0000 0000 c801 0000 0000 0000  ................
00004c0: 5400 0000 0000 0000 0000 0000 0000 0000  T...............
00004d0: 0100 0000 0000 0000 0000 0000 0000 0000  ................1
```

